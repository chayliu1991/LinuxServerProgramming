# IP 服务的特点

IP 协议是 TCP/IP 协议族的动力，它为上层协议提供**无状态、无连接、不可靠的服务* **。

## 无状态

IP 通信双方不同步传输数据的状态信息，因此所有 IP 数据报的发送，传输和接收都是相互独立的，没有上下文关系的。这种服务最大的特点就是无法处理乱序和重复的 IP 数据报。

虽然 IP 数据报头部提供了一个标识符字段用以标识一个 IP 数据报，但它是用来处理 IP 分片和重组的，而不是用来指示接收顺序的。

无状态的优点：简单，高效。

## 无连接

IP 通信双方都不长久地维持对方的任何信息，这样上层协议每次发送数据的时候，都必须明确指定对方的 IP 地址。

## 不可靠

不可靠是指 IP 协议不能保证 IP 数据报准确地到达接收端，它只是承诺尽最大努力送达。发送端 IP 模块一旦检测到 IP 数据报发送失败，就通知上层协议发送失败，而不会试图重传。因此使用 IP 服务的上层协议需要自己实现数据确认，超时重传等机制以达到可靠传输的目的。

很多情况都能导致 IP 数据报发送失败，比如某个中转路由器发现 IP 数据报在网络上存活时间太久了，它将丢弃之，并返回一个 ICMP 错误信息给发送端。

# IPv4 头部

Ipv4 头部长度通常为 20 字节，除非含有可变长的选项部分。

![](./img/Ipv4.png)

- 4 位版本号：指定 IP 协议的版本，对 IPv4 来说是 4。

- 4 位头部长度：标识该 IP 头部有多少个 32 bit 字(4字节)。因为 4 位最大能表示 15，所以 IP 头部最长是 60 字节。

- 8 位服务类型(TOS，Type of Service)：包括一个 3 位优先权字段(现在已经被忽略)，4 位的 TOS 字段分别表示：最小延时，最大吞吐量，最高可靠性，最小费用。其中最多有一个能置1，应用程序应该根据实际需要来设置。例如 ssh 和 telnet 需要最小延迟服务，ftp 需要最大吞吐量服务。

- 16 位总长度：整个 IP 数据报的长度，以字节为单位，IP 数据报的最大长度为 65535 字节，但是由于 MTU 的限制，长度超过 MTU 的数据将被分片传输，所以实际传输的 IP 数据报的长度都远远没有达到最大值。

- 16 位标识：唯一的标识主机发送的每一个数据报，其初始值由系统随机生成，每发送一个数据报，其值就加1，该值在数据报分片时被复制到每个分片中，因此同一个数据报的所有分片具有相同的标识值。

- 3 位标志字段：

  - 第一位：保留。
  - 第二位：标识禁止分片，如果设置了这个位，IP 模块将不对数据报进行分片，这种情况下，如果 IP 数据报长度超过 MTU 的话，IP 模块将丢弃该数据报并返回一个 ICMP 差错报文。
  - 第三位：表示更多分片，除了数据报的最后一个分片外，其它分片都要把它设置为 1。

- 13 位分片偏移：分片相对原始 IP 数据报开始处(仅指数据部分)的偏移，实际的偏移值是该值左移 3 位(乘8)后得到的，由于这个原因，除了最后一个 IP 分片外，每个 IP 分片的数据部分长度必须是 8 的整数倍，这样才能保证后面的 IP 分片拥有一个合适的偏移量。

- 8 位生存时间(Time To Live，TTL)：是数据报到达目的地之前允许经过的路由跳数，TTL 值被发送端设置(常见值是 64)。数据报在转发过程中没经过一个路由，该值就被路由器减1，当 TTL 值减为 0 时，路由器将丢弃数据报，并向源端发送一个 ICMP 差错报文，TTL 值可以防止数据报陷入路由循环。

- 8 位协议：区分上层协议，ICMP 是1，TCP 是 6，UDP 是 17，这些字段定义在 `/etc/protocols` 中。

- 16 位头部校验和：发送端填充，接收端对其使用 CRC 算法检验 IP 数据报头部(仅检验头部)在传输过程中是否损坏。

- 32 位的源端 IP 地址和目的端 IP 地址用来标识数据报的发送端和接收端。一般情况下，这两个地址在整个数据报的传递过程中保持不变，而不论中间经过多少次路由器。

- 可变长的可选信息：这部分最多包含40 字节，因为 IP 头部最长是 60 字节，其中 20 字节是固定部分，可用的 IP 选项包括：

  - 记录路由：告诉数据报途径的所有路由器都将自己的 IP 地址填入 IP 头部的选项部分，这样可以跟踪数据报的传递路径。
  - 时间戳：告诉路由器将数据报被转发的时间(或时间与IP地址对)填入 IP 头部的选项部分这样就可以测量途径路由之间的数据报传输的时间。
  - 松散路由选择：指定一个路由器 IP 地址列表，数据报发送过程中必须经过其中所有的路由器。
  - 严格路由选择，跟松散路由选择类似，不过数据报只能经过指定的路由器。

  ## tcpdump 查看 IPv4 头部结构

  ```
  sudo tcpdump -ntx -i lo # 抓取本地回路上的数据包
  telnet 127.0.0.1
  ```

  结果：

  ```
  IP 127.0.0.1.45884 > 127.0.0.1.23: Flags [S], seq 1456612487, win 65495, options [mss 65495,sackOK,TS val 4020020091 ecr 0,nop,wscale 7], length 0
          0x0000:  4510 003c dbe8 4000 4006 60c1 7f00 0001
          0x0010:  7f00 0001 b33c 0017 56d2 2487 0000 0000
          0x0020:  a002 ffd7 fe30 0000 0204 ffd7 0402 080a
          0x0030:  ef9c a37b 0000 0000 0103 0307
  ```

  此数据包共 60 字节，其中 IP 头部 20 字节，TCP 头部 40 字节。不包含应用程序数据(length 的值为0)。

  



































